name: terraform-dev

# ------------------------------------------------------------------------------
# Déclenchement manuel (propre pour commencer / pour éviter les apply automatiques)
# ------------------------------------------------------------------------------
on:
  workflow_dispatch:

# ------------------------------------------------------------------------------
# Permissions minimales :
# - id-token: write  -> OBLIGATOIRE pour OIDC/WIF
# - contents: read   -> checkout du code
# ------------------------------------------------------------------------------
permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-latest

    # ----------------------------------------------------------------------------
    # Variables d'environnement du job
    # ENV=dev pilote ton Makefile (tf-init/tf-plan/tf-apply)
    # ----------------------------------------------------------------------------
    env:
      ENV: dev

    steps:
      # --------------------------------------------------------------------------
      # 1) Checkout
      # --------------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------------
      # 2) Auth Google Cloud via WIF (zéro clé JSON)
      #
      # IMPORTANT :
      # - On utilise les mêmes secrets partout (pas de doublon)
      # - workload_identity_provider doit être le FULL NAME (projects/5186.../providers/...)
      # --------------------------------------------------------------------------
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      # --------------------------------------------------------------------------
      # 3) Setup gcloud (optionnel pour Terraform, mais très utile pour debug)
      # --------------------------------------------------------------------------
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # --------------------------------------------------------------------------
      # 4) Vérification rapide : est-ce que je suis bien authentifié ?
      # --------------------------------------------------------------------------
      - name: Verify gcloud auth
        run: |
          gcloud auth list
          gcloud config set project "${{ secrets.GCP_PROJECT_ID }}"
          gcloud config get-value project

      # --------------------------------------------------------------------------
      # 5) Installer Terraform
      # --------------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # --------------------------------------------------------------------------
      # 6) Terraform init + plan via ton Makefile (standardisation “entreprise”)
      #
      # Note :
      # - make tf-plan appelle déjà tf-init chez toi
      # - mais je garde des steps séparés pour des logs plus lisibles
      # --------------------------------------------------------------------------
      - name: Terraform init (dev)
        run: make tf-init ENV=${ENV}

      - name: Terraform plan (dev)
        run: make tf-plan ENV=${ENV}

      # --------------------------------------------------------------------------
      # 7) Terraform apply (désactivé volontairement)
      # - Quand tu veux l'activer : tu décommentes ce bloc
      # - Ou tu crées un second workflow “terraform-apply-dev”
      # --------------------------------------------------------------------------
      # - name: Terraform apply (dev)
      #   run: make tf-apply ENV=${ENV}