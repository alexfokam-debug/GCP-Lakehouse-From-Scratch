name: CI

# ------------------------------------------------------------------------------
# Déclencheurs :
# - pull_request : vérifie avant merge
# - push main    : vérifie après merge
# ------------------------------------------------------------------------------
on:
  pull_request:
  push:
    branches: ["main"]

# ------------------------------------------------------------------------------
# Permissions :
# - contents: read   -> checkout
# - id-token: write  -> pour faire un plan Terraform “réel” avec WIF
#
# IMPORTANT :
# Sans id-token, tu ne peux pas faire WIF et ton plan peut échouer
# dès que tu as des data sources / backends / APIs.
# ------------------------------------------------------------------------------
permissions:
  contents: read
  id-token: write

jobs:
  terraform-ci:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------------------------
      # 1) Checkout
      # --------------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------------
      # 2) Auth GCP via WIF (pour un plan fiable)
      # --------------------------------------------------------------------------
      - name: Authenticate to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      # --------------------------------------------------------------------------
      # 3) Setup Terraform
      # --------------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # --------------------------------------------------------------------------
      # 4) terraform fmt check (hygiène)
      # --------------------------------------------------------------------------
      - name: Terraform fmt check
        working-directory: terraform
        run: terraform fmt -check -recursive

      # --------------------------------------------------------------------------
      # 5) terraform init + validate
      # --------------------------------------------------------------------------
      - name: Terraform init (dev)
        working-directory: terraform
        run: terraform init -reconfigure -backend-config=envs/dev/backend.hcl

      - name: Terraform validate
        working-directory: terraform
        run: terraform validate

      # --------------------------------------------------------------------------
      # 6) terraform plan (dev) : PAS de apply en CI
      #
      # Note :
      # - On ne met plus "|| true" : si ça casse, on veut le voir.
      # - Si tu veux tolérer les échecs sur certains changements, on le fait
      #   avec une logique explicite, pas en masquant tout.
      # --------------------------------------------------------------------------
      - name: Terraform plan (dev)
        working-directory: terraform
        run: terraform plan -var-file=envs/dev/terraform.tfvars