name: CD-DEV

# ------------------------------------------------------------------------------
# Déclencheur :
# - Push sur main => déploiement DEV + Dataform
# - Optionnel : workflow_dispatch pour lancer manuellement
# ------------------------------------------------------------------------------
on:
  push:
    branches: ["main"]
  # workflow_dispatch: {}

# ------------------------------------------------------------------------------
# Permissions MINIMALES pour WIF/OIDC :
# - contents: read   -> checkout
# - id-token: write  -> indispensable pour OIDC (WIF)
# ------------------------------------------------------------------------------
permissions:
  contents: read
  id-token: write

# ------------------------------------------------------------------------------
# Concurrency :
# - Empêche 2 runs en parallèle sur DEV (push successifs)
# - cancel-in-progress = true => annule l'ancien run si un nouveau arrive
# ------------------------------------------------------------------------------
concurrency:
  group: cd-dev
  cancel-in-progress: true

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------------------------
      # 1) Checkout
      # --------------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------------
      # 2) Auth Google Cloud via Workload Identity Federation (WIF)
      # --------------------------------------------------------------------------
      - name: Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v2
        with:
            token_format: "access_token"
            project_id: ${{ secrets.GCP_PROJECT_ID }}
            workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
            service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}
            create_credentials_file: true
            export_environment_variables: true

      # --------------------------------------------------------------------------
      # 3) Setup gcloud (utile pour debug + certaines commandes)
      # --------------------------------------------------------------------------
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # --------------------------------------------------------------------------
      # 4) Vérification d’auth (debug)
      # --------------------------------------------------------------------------
      - name: Verify identity + backend bucket access
        run: |
          echo "== gcloud auth list =="
          gcloud auth list
          echo "== project =="
          gcloud config set project "${{ secrets.GCP_PROJECT_ID }}"
          gcloud config get-value project
          echo "== check TF state bucket =="
          gcloud storage ls gs://lakehouse-terraform-states-486419 || true
          gcloud storage ls gs://lakehouse-terraform-states-486419/gcp-lakehouse/dev/ || true
        

        # --------------------------------------------------------------------------
      # 5) Setup Terraform
      # --------------------------------------------------------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # --------------------------------------------------------------------------
      # 6) Terraform init
      # --------------------------------------------------------------------------
      - name: Terraform init (dev)
        working-directory: terraform
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          terraform version
          terraform init -reconfigure -backend-config=envs/dev/backend.hcl

      # --------------------------------------------------------------------------
      # 7) Terraform plan (DEV) -> on sort un planfile
      # - Bonne pratique : apply = EXACTEMENT ce plan
      # --------------------------------------------------------------------------
      - name: Terraform plan (dev)
        working-directory: terraform
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          terraform plan -var-file=envs/dev/terraform.tfvars -out=tfplan

      # --------------------------------------------------------------------------
      # 8) Terraform apply (DEV) basé sur le planfile
      # --------------------------------------------------------------------------
      - name: Terraform apply (dev)
        working-directory: terraform
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          terraform apply -auto-approve tfplan

      # --------------------------------------------------------------------------
      # 9) Setup Python 3.11 + cache pip (plus rapide + stable)
      # --------------------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # --------------------------------------------------------------------------
      # 10) Install deps Python
      # - si requirements.txt existe => install
      # - sinon deps minimales pour ton runner Dataform
      # --------------------------------------------------------------------------
      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install google-auth requests pyyaml

      # --------------------------------------------------------------------------
      # 11) Run Dataform DEV
      # - Ton Makefile mappe ENV=dev => wf-dev-on-demand
      # --------------------------------------------------------------------------
      - name: Dataform run (dev)
        run: |
          make dataform-run ENV=dev